{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="card border-0 shadow-sm mb-4 bg-light">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <span class="badge bg-primary mb-2">Talep Edilen Malzeme</span>
                <h3 class="mb-0 text-dark">{{ talep.malzeme.isim }}</h3>
            </div>
            <div class="text-end">
                <h2 class="display-6 fw-bold text-primary mb-0">
                    <span id="talep-miktar">{{ talep.miktar }}</span> 
                    <span class="fs-5 text-muted">{{ talep.malzeme.get_birim_display }}</span>
                </h2>
                <small class="text-muted">Proje Yeri: {{ talep.proje_yeri|default:"Genel" }}</small>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-7">
            <div class="card border-0 shadow">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="fas fa-edit text-warning"></i> Teklif Girişi</h5>
                </div>
                <div class="card-body p-4">
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label class="form-label text-muted fw-bold small text-uppercase">Tedarikçi Firma</label>
                            {{ form.tedarikci }}
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label text-muted fw-bold small text-uppercase">Birim Fiyat</label>
                                <div class="input-group input-group-lg">
                                    {{ form.fiyat }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted fw-bold small text-uppercase">Para Birimi</label>
                                {{ form.para_birimi }}
                            </div>
                        </div>

                        <div class="mb-4" id="kur-alani" style="display:none;">
                            <label class="form-label text-muted fw-bold small text-uppercase">Güncel Kur (TL Karşılığı)</label>
                            <input type="number" id="manuel-kur" class="form-control" step="0.0001" value="1.00" oninput="hesapla()" placeholder="Örn: 32.50">
                            <div class="form-text">TL karşılığını hesaplamak için kur giriniz.</div>
                        </div>

                        <div class="row mb-4 align-items-center bg-light p-3 rounded mx-1">
                            <div class="col-md-6">
                                <label class="form-label fw-bold mb-0">KDV Oranı</label>
                                {{ form.kdv_orani }}
                            </div>
                            <div class="col-md-6 d-flex align-items-center justify-content-end mt-3 mt-md-0">
                                {{ form.kdv_dahil_mi }}
                                <label class="form-check-label fw-bold ms-2 text-dark">Fiyata KDV Dahil</label>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning btn-lg fw-bold shadow-sm">
                                <i class="fas fa-save"></i> Teklifi Kaydet
                            </button>
                            <a href="{% url 'teklif_yonetimi' talep.id %}" class="btn btn-light btn-lg">Vazgeç</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card border-0 shadow bg-primary text-white h-100">
                <div class="card-body d-flex flex-column justify-content-center p-4">
                    <h5 class="text-white-50 border-bottom pb-2 mb-3">Hesaplanan Toplam Maliyet</h5>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Malzeme Tutarı:</span>
                        <span class="fw-bold"><span id="ozet-ara-toplam">0.00</span> <span class="birim-simge">₺</span></span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span>KDV Tutarı:</span>
                        <span class="fw-bold"><span id="ozet-kdv">0.00</span> <span class="birim-simge">₺</span></span>
                    </div>

                    <div class="bg-white text-primary p-3 rounded text-center mb-3">
                        <small class="text-uppercase fw-bold ls-1">Ödenecek Toplam Tutar</small>
                        <h1 class="mb-0 fw-bold display-5">
                            <span id="ozet-genel-toplam">0.00</span> 
                            <span class="birim-simge fs-3">₺</span>
                        </h1>
                    </div>

                    <div id="tl-karsiligi-container" class="text-center mt-2" style="display:none;">
                        <div class="text-white-50 small">Yaklaşık TL Karşılığı</div>
                        <h3 class="mb-0 fw-bold text-warning">
                            ≈ <span id="ozet-tl-karsiligi">0.00</span> ₺
                        </h3>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Sayfa Yüklendiğinde Çalıştır
    document.addEventListener("DOMContentLoaded", function() {
        kurKontrol();
        hesapla();
    });

    function kurKontrol() {
        const paraBirimi = document.getElementById('id_para_birimi').value;
        const kurAlani = document.getElementById('kur-alani');
        const tlContainer = document.getElementById('tl-karsiligi-container');
        const manuelKur = document.getElementById('manuel-kur');

        // Simgeleri Güncelle
        let simge = '₺';
        if(paraBirimi === 'USD') simge = '$';
        else if(paraBirimi === 'EUR') simge = '€';
        else if(paraBirimi === 'GBP') simge = '£';

        document.querySelectorAll('.birim-simge').forEach(el => el.textContent = simge);

        // TL değilse Kur Alanını Aç
        if (paraBirimi !== 'TRY' && paraBirimi !== '') {
            kurAlani.style.display = 'block';
            tlContainer.style.display = 'block';
        } else {
            kurAlani.style.display = 'none';
            tlContainer.style.display = 'none';
            manuelKur.value = "1.00"; // TL ise kur 1'dir
        }
        hesapla();
    }

    function hesapla() {
        // 1. Verileri Al
        // Django'dan gelen miktar virgüllü olabilir (örn: 500,00), JS için noktaya çeviriyoruz.
        let miktarStr = document.getElementById('talep-miktar').textContent.replace(',','.'); 
        let miktar = parseFloat(miktarStr) || 0;

        let birimFiyat = parseFloat(document.getElementById('id_fiyat').value) || 0;
        let kdvOrani = parseInt(document.getElementById('id_kdv_orani').value) || 0;
        let kdvDahilMi = document.getElementById('id_kdv_dahil_mi').checked;
        let kur = parseFloat(document.getElementById('manuel-kur').value) || 1;

        // 2. Matematiksel Hesaplama
        let toplamTutar = miktar * birimFiyat;
        let kdvTutari = 0;
        let genelToplam = 0;
        let araToplam = 0;

        if (kdvDahilMi) {
            // Fiyat KDV Dahil girildiyse
            genelToplam = toplamTutar;
            // KDV'yi içinden ayıklama formülü: Tutar / (1 + Oran/100)
            araToplam = genelToplam / (1 + (kdvOrani / 100));
            kdvTutari = genelToplam - araToplam;
        } else {
            // Fiyat KDV Hariç girildiyse
            araToplam = toplamTutar;
            kdvTutari = araToplam * (kdvOrani / 100);
            genelToplam = araToplam + kdvTutari;
        }

        // 3. Ekrana Yazdır (Formatlı: 1.250,00 şeklinde)
        document.getElementById('ozet-ara-toplam').textContent = araToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('ozet-kdv').textContent = kdvTutari.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('ozet-genel-toplam').textContent = genelToplam.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // 4. TL Karşılığı Hesabı
        if (document.getElementById('id_para_birimi').value !== 'TRY') {
            let tlKarsiligi = genelToplam * kur;
            document.getElementById('ozet-tl-karsiligi').textContent = tlKarsiligi.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
    }
</script>
{% endblock %}